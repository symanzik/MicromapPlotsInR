# Linked Micromap Plots via the **micromapST** R Package {#Ch3}


\chapterauthor{Linda Williams Pickle, James Blackwood Pearson, Jr., Daniel B. Carr}


Similar to Chapter \@ref(Ch2), the **micromapST**\index{R Packages!micromapST} R package [@CP2015CRAN],
accessible at https://cran.r-project.org/web/packages/micromapST/index.html,
will be introduced in this chapter. The reader will learn how to create a 
basic linked micromap plot\index{Linked micromap plot} via this R package. 
Although the default parameter settings give publication-ready output,
details will be provided on setting up additional labels and optional cumulative shading
which displays the growing geographic shading as one moves from the top to bottom
of the full plot.


## Introduction {#Ch3-Introduction}

- will define linked micromap plot (ref back to Ch 1)
- uses of LMMs: teaching tool, communication of geostatistics, investigation of patterns leading to followup analyses
- history of micromapST: 1st coded in R, then in JAVA for State Cancer Profiles at NCI, then an R package
- evolution from only US states to include NCI cancer registry boundaries and selected state/county, country boundaries

## Basic Plot Layout and Function Call {#Ch3-Basics}

- Introduce the most basic linked micromap plot from micromapST, using only default settings except for data specification; data = cumulative # covid cases by state on 11/20/20
- in this example, column order left to right = map, state label, dot plot

```{r Ch3-micromap1, fig.cap = 'Prevalence of covid-19 cases by U.S. state on Nov. 20, 2020', fig.width = 7, fig.height = 9}

library(micromapST)

# Input data files.
# Data Set # 1
STcovidcaserates = read.csv('data/STCaseRatesFeb242020Apr142022.csv',row.names=2)
head(STcovidcaserates,n=2L)
panelDesc = data.frame(
  type=c('map','id','dot'),  
  lab1=c('','','Cases/100,000'),		
  col1=c(NA,NA,'Nov_20_2020')
 )


# default = alphabetic state name sort
micromapST(STcovidcaserates,panelDesc,
            title=c('US State Covid Case Rates, Nov. 20, 2020'))  
```

- this doesn't show anything
- sort to bring out geographic patterns (by case rate in descending order)
- reuse last paneldesc

```{r Ch3-micromap2, fig.cap = 'Prevalence of covid-19 cases by U.S. state on Nov. 20, 2020', fig.width = 7, fig.height = 9}
micromapST(STcovidcaserates,panelDesc,
            sortVar='Nov_20_2020',ascend=F,
            title=c('US State Covid Case Rates, Nov. 20, 2020'))  
```

- Here we can see that ND & SD + surrounding states were high in the fall of 2020
- story behind date choices: There was a huge motorcycle rally in Sturgis ND during the 1st 2 weeks of Aug 2020 that in hindsight was thought to be a covid superspreader event, because (1) 50,000 people were crowded together
-   (ck #) and (2) most attendees were strongly against mask mandates. Ref MMWR article
- now add a 2nd variable, look for correlation with 1st variable
- 2nd var = % who reported that they usually wore a mask in public on a Facebook survey in Sept 2020

```{r Ch3-micromap3, fig.cap = 'Prevalence of covid-19 cases on Nov. 20, 2020, and % who usually wore a mask in Sep. 2020', fig.width = 7, fig.height = 9}

# Input data files.
# Data Set # 1
panelDesc = data.frame(
  type=c('map','id','dot','dot'),  
  lab1=c('','','Cases/100,000','% wore mask'),		
  col1=c(NA,NA,'Nov_20_2020','PctWoreMask0920')
 )

micromapST(STcovidcaserates,panelDesc,
           sortVar='Nov_20_2020',ascend=F,
            title=c('US State Covid Case Rates, Nov. 20, 2020 and % who usually wore a mask in Sep. 2020'))  
```

- This micromap supports the theory that the Sturgis superspreader event, i.e., exposure in ND in Aug 2020 led to infections within the following month in surrounding states where most attendees came from.
- We see that ND & SD had very high totals in Nov 20 and residents there reported relatively low mask wearing in Sep

## Display Options {#Ch3-DisplayOpt}

In this section we illustrate some optional display options, such as full name labels, cumulative shading, color
choices, enhanced labels and a vertical reference line. A reference is made to changing the number of rows per
perceptual group, to be illustrated in the next section.


- in this figure, add cumulative shading to map, add error bar to dot for % wore mask, change to full state name, add US reference line
- ck whether data has stderr or stddev, fix if necessary

```{r Ch3-micromap4, fig.cap = 'Prevalence of covid-19 cases on Nov. 20, 2020, and % who usually wore a mask in Sep 2020, with optional error bars, cumulative map shading and full state names', fig.width = 7, fig.height = 9}

# Input data files.
# Data Set # 1
panelDesc = data.frame(
  type=c('mapcum','id','dot','dotse'),
  lab1=c('','','Cases/100,000','% wore mask'),		
  col1=c(NA,NA,'Nov_20_2020','PctWoreMask0920'),
  col2=c(NA,NA,NA,'PctMaskStderr'),
  refVals=c(NA,85),refTexts='US %'
 )

micromapST(STcovidcaserates,panelDesc,
            sortVar='Nov_20_2020',ascend=F,
            plotNames='full',
            title=c('US State Covid Case Rates, Nov. 20, 2020 and % who usually wore a mask in Sep. 2020'))  
```

- cumulative shading shows an enlarging cluster of states in the N. Central region of the US, consistent with the superspreader ND motorcycle rally hypothesis
- by adding a confidence bar to the mask % dot, we can see that even though ND & SD %s have a wide bar, they are still much lower than most other states
- adding the US referent line (85%) shows that the highest 15 case rates are in states with below US mask wearing %
-    and the lowest 30 rates are in states with above US mask wearing %

- in the next figure, move maps to right, add 2nd label lines, change dotse to bar, change colors to gray shades

```{r Ch3-micromap5, fig.cap = 'Prevalence of covid-19 cases on Nov. 20, 2020, and % who usually wore a mask in Sep 2020, with different colors, expanded labels and bar glyph', fig.width = 7, fig.height = 9}

# Input data files.
# Data Set # 1
panelDesc = data.frame(
  type=c('id','dot','bar','mapcum'),
  lab1=c('','Cases/100,000','% wore mask',''),
  lab2=c('','Nov 20, 2020','Sep 2020',''),
  col1=c(NA,'Nov_20_2020','PctWoreMask0920',NA),
  col2=c(NA,NA,'PctMaskStderr',NA),
  refVals=c(NA,85),refTexts='US %'
 )

micromapST(STcovidcaserates,panelDesc,
            sortVar='Nov_20_2020',ascend=F,
            plotNames='full',
            colors='grays',
            title=c('US State Covid Case Rates, Nov. 20, 2020 and % who usually wore a mask in Sep. 2020'))  
```
- I don't think that the gray scale works as well as colors but sometimes a publisher can't do color
- comment on how to specify other colors

## Changing Perceptual Group Size {#Ch3-PerceptGroups}

- now change dataset to Maryland by county, % residents with 4+ years of college & % living <150% federal poverty level
- 1st micromap uses default of 5 counties in each perceptual group.
- look for geographic clustering in the state: a well known pattern in MD: highest ed in DC suburbs/central MD,
-   then southern MD, then lower Eastern Shore & Western MD.

```{r Ch3-micromap6, fig.cap = 'Percent residents with income < 150% federal poverty level and % with 4+ years of college', fig.width = 7, fig.height = 9}

library(micromapST)

# Input data files.
# Data Set # 1
MDPovEd = read.csv('data/MDPovEducACSData20162020.csv',row.names=3)
head(MDPovEd)
panelDesc = data.frame(
  type=c('mapcum','id','dot','dot'),  
  lab1=c('','','% College','% Pov'),		
  col1=c(NA,NA,'PctBachDegree','PctLess150Pov')
 )

# sort by % college
micromapST(MDPovEd,rowNames='id',panelDesc,sortVar='PctBachDegree',ascend=F,bordGrp='MarylandBG',
            plotNames='full',
            title=c('Maryland counties: % Living < 150% of Poverty Level and % with 4+ Years of College'))  
```

- change perceptual group size to c(5,4,3,3,4,5), see if the geographic patterns are any clearer (probably not)


```{r Ch3-micromap7, fig.cap = 'Percent residents with income < 150% federal poverty level and % with 4+ years of college - smaller perceptual groups', fig.width = 7, fig.height = 9}

library(micromapST)

# Input data files.
# Data Set # 1
MDPovEd = read.csv('data/MDPovEducACSData20162020.csv',row.names=3)
head(MDPovEd)
panelDesc = data.frame(
  type=c('mapcum','id','dot','dot'),  
  lab1=c('','','% College','% Pov'),		
  col1=c(NA,NA,'PctBachDegree','PctLess150Pov')
 )

# sort by % college
micromapST(MDPovEd,rowNames='id',panelDesc,sortVar='PctBachDegree',ascend=F,bordGrp='MarylandBG',
            plotNames='full',grpPattern=c(5,4,3,3,4,5),
            title=c('Maryland counties: % Living < 150% of Poverty Level and % with 4+ Years of College'))  
```

## Conclusions {#Ch3-Conclusions}

- default layout is of publishable quality and gets you pretty far along in displaying the data in a meaningful way
- options to enhance the display are presented
- easy to use & to change options, quick to run, so good for teaching, communicating spatial patterns & generating hypotheses for further analysis


## Further Reading {#Ch3-FurtherReading}

- Purposes and uses of the micromapST package to date

Introduce cross-references to other chapters, e.g., Chapter \@ref(Ch1) and Chapter \@ref(Ch2),
where related work and further examples can be found in this book that match the content of this
chapter, that follow up on this chapter, or that are a prerequisite of this chapter.

Also, do some scientific literature review here that is specific to your chapter.
Where has this R package been introduced and used before, where have other plot types
or different countries been used in micromaps, what were other applications 
of micromaps that are related to the title and content of your chapter, etc.?


\printbibliography[segment=\therefsegment,heading=subbibliography]

