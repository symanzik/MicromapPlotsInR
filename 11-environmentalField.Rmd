# Applications for the Environmental Field {#Ch11}


\chapterauthor{Michael G. McManus, Marcus W. Beck, J{\"u}rgen Symanzik}

## Introduction {#Ch11-Introduction}
This chapter will give the purpose and description of linked micromaps as applied to environmental data using the R package **micromap**\index{R Packages!micromap}. We will ask what types of environmental data are most suited for summarizing and displaying as linked micromaps. Additionally, we will show how linked micromaps can be used in spatial data analysis. Our linked micromap examples are drawn from federal and state environmental agencies in the United States.

The purpose of a linked micromap is to show spatial locations corresponding to statistical estimates [@COCPC1998]. Linked micromaps simultaneously summarize and display both statistical and geographic distributions by linking statistical summaries of polygons, or areal units, to a series of small maps [@PMWOK2015JSS]. Implicit with this purpose and description is that space, defined as spatial contiguity of polygons, provides some context to the statistical estimates, and that the statistical estimates are representative of the polygons. That spatial context to statistical estimates can be one of three patterns:  spatial similarity among neighbors, spatial dissimilarity among neighbors, or no spatial pattern among neighbors. @MPRG2016 illustrated that first pattern, while the examples below by the Virginia Department of Environmental Quality (VDEQ) and Florida Department of Environmental Protection (FDEP) illustrate the second and third patterns, respectively [@SWSCSS2018;@VirginiaDEQ2020]. All three of those examples also addressed the issue of obtaining statistical estimates of environmental data that were representative of watersheds, the polygons, used in the analysis. 

Public health statistics are often reported by administrative boundaries, such as counties, states, or countries, whereas environmental statistics are often reported by boundaries of natural features, such as watersheds, estuaries, or ecoregions. A census of environmental characteristics from such natural features is not possible. Consequently, environmental statisticians have recommended probability-based surveys or sampling to obtain representative estimates of natural resources [@PUW1999]. Probability-based surveys have three steps:  1) Identify the total or target population of interest (e.g. all wadeable streams in Virginia), 2) Select a random sample to ensure representativeness with the known probability of including any member of the target population, and 3) apply the sample weight, the inverse of the probability, to the environmental measurements so that inferences can be made to the target populations based on the samples [@PUW1999]. @SO2004 introduced spatially balanced probabilistic surveys as having sample sites distributed evenly over the extent of the natural resource is more efficient than a random sample of sites, in which clumping of sites may occur. The design and analysis of spatially balanced probabilistic surveys is done using the R package Spatial Sampling Design and Analysis, **spsurvey**\index{R Packages!spsurvey} [@DKOW2022; @OKP2012]. Statistical estimates of aquatic natural resources have been made from spatially balanced probabilistic surveys of ecoregions of the conterminous United States as part US EPA’s National Aquatic Resource Surveys to watersheds within a state.

## Recent Geovisualizations with Environmental Data {#Ch11-Geovisualizations}

Virginia Department of Environmental Quality and Florida Department of Environmental Protection both implemented spatially balanced probabilistic surveys of aquatic resources and visualized the results of the surveys using linked micromaps.  Under the Clean Water Act in the United States, states must report on the condition or status of their lakes, rivers, streams, and estuaries.  To meet this requirement, VDEQ has conducted such surveys of perennial, non-tidal, wadeable streams and rivers from 2001-2018 and has collected aquatic macroinvertebrates at stream sites for biological monitoring [@VirginiaDEQ2020]. The aquatic macroinvertebrates indicate the ecological conditions of a stream and are expressed as a Stream Condition Index (SCI) on a numeric scale, and from the surveys estimates of the SCI score can be made among the 11 major river basins in Virginia and compared to a statewide threshold value [@VirginiaDEQ2020]. The higher the index score indicates better ecological condition of the streams.

```{r Ch11-micromapVDEQ, fig.width = 7, fig.height = 9, fig.cap = 'A Virginia Linked Micromap.', eval = TRUE, echo = FALSE}
library(micromap)

# initial example
stats <- readRDS("data/stats.RDS")
map.table <- readRDS("data/map.table.RDS")

 mmplot(stat.data=stats,
         map.data=map.table,
         map.link=c("Basin", "ID"),
         panel.types=c('dot_legend', 'labels','labels', 'dot_cl', 'map'),
         panel.data=list(NA,'Basin','n',list('x50', 'x25', 'x75'),NA),
         ord.by='x50',
         grouping=c(4,3,4),
         vertical.align = "center",
         median.row=F,
         plot.height=7,
         plot.width=8,
         colors=brewer.pal(3, "Spectral"),
         rev.ord=T,
         panel.att=list(list(1, point.type=20, point.border=TRUE, point.size=2),
                        list(2, header='Basin', panel.width=.5, 
                             align='left', text.size=.9),
                        list(3,header='n',panel.width=.2,align='left',text.size=.9),
                        list(4, header='Estimated Median VSCI/VCPMI Score and \nAssociated Interquartile Range',
                             graph.bgcolor='lightgray', point.size=1.5,
                             xaxis.ticks=list(40,50,60,70,80), xaxis.labels=list(40,50,60,70,80)
                             ,add.line=60,add.line.col='black',add.line.typ='dashed',
                             xaxis.title='VSCI Score'),
                        list(5, header='Light Gray Means\nPreviously Displayed',
                             map.all=TRUE, fill.regions='aggregate',
                             active.border.color='black', active.border.size=1.0,
                             inactive.border.color=gray(.7), inactive.border.size=1, 
                             panel.width=1.0)))
 
```

Unlike a choropleth map, the SCI linked micromap produced by VDEQ displays *both* a measure of central tendency and a measure of variation for each of the 11 major river basins Figure \@ref(fig:Ch11-micromapVDEQ). Specifically, the statistical panel of the linked micromap shows the estimated median SCI score and the interquartile range (IQR), as the estimated 25th and 75th percentiles, with the basins ranked by their medians. Those statistics are compared to a statewide threshold SCI of 60. Close inspection of the linked micromap reveals an interesting spatial dissimilarity for the southwestern basins of Holston, Clinch-Powel, and Big Sandy, all of which are part of the Tennessee River drainage, as Holston has excellent condition based on its SCI score, Clinch-Powell has good condition, and Big Sandy has severe stress. Also, worth noting, is that the 75th percentile of the poorest scoring basin, Rappahannock, extends past the statewide threshold indicates that some sites might benefit from conservation efforts as opposed to poorer scoring sites, which might need remediation to improve their condition. The Integrated Report included additional linked micromaps having two statistical panels, with one panel having the basin estimates of a water quality stressor and that was paired with another panel of the SCI [@VirginiaDEQ2020]. That pairing of a potential stressor with the SCI response provided a visualization of stressors that might have a larger impact on aquatic macroinvertebrates relative to other basins [@VirginiaDEQ2020]. The VDEQ linked micromap provided a means to show measures of variation, along with comparison to a reference value. 

While the VDEQ R code builds off Chapter \@ref(Ch2), some distinct arguments and layouts are worth mentioning. The VDEQ linked micromap feature asymmetrical perceptual grouping as specified by `grouping=c(4,3,4)`, followed by `vertical.align = "center"`. That argument aligns the rows within a perceptual group, rather than the default alignment of "top". The center alignment is helpful when perceptual groups contain different number of rows. This is a five panel linked micromap showing a unique aspect of two label panels by using this syntax: `panel.types=c('dot_legend', 'labels','labels', 'dot_cl', 'map')`. The first label specification corresponds to Basin in the `panel.data`, while the second label specification corresponds to n.  From both of those calls, the linked micromap displays the names of basin and their sample size. The VDEQ ecologists cleverly recognized that they could report a three-number summary of estimates of the median, first quartile, and third quartile in their linked micromap simply by using dot_cl.  The dot_cl argument is typically use to report a central tendency estimate, such as a mean or median, and then the lower and upper confidence limits, as @MPRG2016 did. Finally, in that same statistical panel, the overall statewide median estimate of SCI was displayed by using these arguments:
`add.line=60,add.line.col='black',add.line.typ='dashed'`.

Finally, here is the R code that was used to create Figure \@ref(fig:Ch11-micromapVDEQ). That code 
uses of the _stats_\index{Datasets!stats} dataset and the _map.table_\index{Datasets!map.table}

```{r Ch11-micromapVDEQ, eval = FALSE}
```

The next example is from FDEP. Studies of freshwater aquatic ecosystems often need to summarize water quality results from watersheds, as VDEQ did, along with land cover in those watersheds, which is how FDEP used linked micromaps.  Spatially balanced probabilistic surveys were done by FDEP to study emerging contaminants from different types of waterbodies, canals, rivers, streams, small and large lakes, and unconfined aquifers, in 29 drainage basins [@SWSCSS2018]. The results for one of the contaminants, the widely used pesticide imidacloprid, were pooled across waterbody types and summarized with a 4-statistical panel linked micromap of the 29 drainage basins  displaying:  number of surveyed sites, percentage of surveyed sites having detections of imidacloprid, percentage of urban and agricultural land cover in a basin, and a five-number summary, minimum, first quartile, median, third quartile, and maximum, of imidacloprid concentrations shown as a box plot [@SWSCSS2018]. As an exploratory spatial data analysis tool, @SWSCSS2018 noted from the linked micromap that neighboring drainage basins showed no geographic patterning in percentages of detections, and this was confirmed by a no significant spatial autocorrelation detected using Moran’s Index.  This application of linked micromaps was novel in two regards, first, by summarizing different types of data for the polygons of interest, and second, by formally testing if there was geographic patterning in the results.

```{r Ch11-micromapFDEP, fig.width = 7, fig.height = 9, fig.cap = 'A Florida Linked Micromap.',eval = TRUE, echo = FALSE}
library(micromap)

# data frames
Land4_Imida_NA <- readRDS("data/Land4_Imida_NA.rds")
FL_Basins <- readRDS("data/Florida_Basins.rds")

mmplot(stat.data=Land4_Imida_NA, 
                 map.data=FL_Basins,
                 panel.types=c('dot_legend','labels','labels','dot','dot','box_summary','map'),
                 panel.data=list(NA,'GROUP_NAME','Sum_PNT_COUNT','Imidacloprid','Percent_Ag_Ur_Tr',
                                 list('Imida_Min','Imida_25','Imida_Med','Imida_75','Imida_Max'),
                                 NA),       
                 map.link=c('GROUP_NAME','ID'),
                 ord.by='Imidacloprid',
                 rev.ord = TRUE,
                 grouping=c(6,6,5,6,6), ##median.row=F,
                 vertical.align = 'center',
                 plot.panel.spacing = 2,
                 plot.height=6, 
                 plot.width = 9,
                 colors=c('red','orange','yellow', 'green','blue','purple'),
                 print.res = 900,
                 
                 panel.att=list(list(1, point.type=20, point.border=TRUE, panel.width=1, point.size=2),
                                
                                list(2, header='Basin\nName', panel.width=.9, 
                                     align='left', left.margin=-1.6, text.size=.65), 
                                
                                list(3, header='Sample\nSize',panel.width=.1,
                                     align='right', left.margin=-1.6, text.size=.65),
                                
                                list(4, header='Imidacloprid\nDetected',
                                     graph.bgcolor='lightgray', point.size=1,
                                     xaxis.ticks=list(0,25,50,75), xaxis.labels=list(0,25,50,75),
                                     xaxis.title='Percent', left.margin=-1.6,
                                     panel.width=.4),
                                
                                list(5, header='Ag + Urban\nLand Use',
                                     graph.bgcolor='lightgray', point.size=1,
                                     xaxis.ticks=list(0,25,50,75), xaxis.labels=list(0,25,50,75), 
                                     xaxis.title='Percent', left.margin=-1.6,
                                     panel.width=.4),
                                
                                list(6, header='Imidacloprid Median          \nmin, 25th, 75th, & max',
                                     graph.bgcolor='lightgray',
                                     xaxis.ticks=list(-3,-2.5,-2,-1.5,-1,-0.5,0), xaxis.labels=list(-3,-2.5,-2,-1.5,-1,-0.5,0),
                                     xaxis.title='Log micrograms per liter', 
                                     graph.bar.size = 0.4, left.margin=-1.6,
                                     panel.width=.75),
                                
                                list(7, header='Gray Means            \n  Previously Displayed',
                                     map.all=TRUE, fill.regions='aggregate',
                                     active.border.color='black', active.border.size=1, left.margin=-1.6,
                                     panel.width=.6)))


```

In Figure \@ref(fig:Ch11-micromapFDEP), the syntax: `panel.types=c('dot_legend','labels','labels','dot','dot','box_summary','map')` is used in the creation of boxplots.  The `box_summary` requires that _Land4\_Imida\_NA_\index{Datasets!Land4\_Imida\_NA} dataset have columns containing the following summary statistics for imidalcloprid concentrations for each drainage basin:  minimum, first quartile, median, third quartile, and maximum.  The boxplots are displayed in the sixth statistical panel, with the width of the boxplot specified with the argument: `graph.bar.size = 0.4`. Here is the R code that was used to create Figure \@ref(fig:Ch11-micromapFDEP). A challenge mentioned in Chapter \@ref(Ch2) and illustrated with the Florida linked micromap is that of small subareas, which is the Perdido basin, the westernmost basin in Florida.  

```{r Ch11-micromapFDEP, eval = FALSE}
```

## Spatial Surveys and Linked Micromaps {#Ch11-Spatial_Surveys}

As spatially balanced probabilistic surveys often report estimates for areal units, such as watersheds or ecoregions, we will illustrate the drawing of such a survey sample. For more details on the design and analysis of those surveys, the readers should consult [@SO2004; @OKP2012; @DKOW2022].  A spatially balanced probabilistic survey is connected to a linked micromap in that the survey provides the representative samples of the natural feature (lakes, rivers, streams, estuaries, ecoregions) from which estimates are made for the areal units.

Three steps are required to draw a spatially balanced probabilistic survey using the R package **spsurvey**\index{R Packages!spsurvey}: 1) reading in the sample frame, which is a GIS file in the format of shapefile or an R simple feature, or sf, object, 2) specifying the design, and 3) selecting the sample [@OKP2012].  The example sample frame we will use contains points for 3,190 lakes in the state of Oregon in the U.S. and is the same sample frame used by @OKP2012, where readers can get more details on the Generalized Random Tessellation Stratified (GRTS) algorithm). Unlike other spatially balanced sampling algorithms, GRTS can draw samples from sample frames of points, such as lakes, linear networks, such as rivers and streams, or polygons, such as estuaries [@DKOW2022].  For the Oregon lakes, we will draw an equal probability sample of 50 lakes where each site has an equal inclusion probability .  

We begin by plotting the border of Oregon Figure \@ref(fig:Ch11-micromap-oregon), and then points representing the lakes in Oregon Figure \@ref(fig:Ch11-micromap-lakes).  Before we can plot these two simple features together, we first have to check that they have the same coordinate reference system otherwise the two sf objects will not align.  We check that by submitting `st_crs(OR) == st_crs(OR_lakes)`, which returns FALSE.  Submitting `OR_lakes <- st_transform(OR_lakes, st_crs(OR))` transforms the lakes data frame so it now has the same coordinate reference system as the Oregon data frame.  Now, both the Oregon border and lakes can be plotted together Figure \@ref(Ch11-micromap-oregon-lakes).
```{r, Ch11-micromap-oregon, eval = FALSE, fig.cap = 'Plot of Oregon'}
library(spsurvey)
library(tidyverse)
#install.packages("USAboundariesData", repos = "https://ropensci.r-universe.dev", type = "source")
library(USAboundaries)
library(USAboundariesData)

state_names <- c("Oregon")
OR<-us_states(resolution = "high", states = "Oregon") 

plot(OR$geometry, main = "Oregon")
```

```{r, Ch11-micromap-lakes, eval = FALSE, fig.cap = 'Plot of Lakes in Oregon'}
OR_lakes <- read_sf("OR_Lakes_points.shp")

plot(OR_lakes$geometry, main='Oregon Lakes')
```

```{r, Ch11-micromap-crs-check1, eval = FALSE, echo = FALSE}
# do the two sf objects have the same crs (coordinate reference system)?
st_crs(OR) == st_crs(OR_lakes)

# FALSE, which means an st_transform is needed so they have the same crs

OR_lakes <- st_transform(OR_lakes, st_crs(OR))

st_crs(OR) == st_crs(OR_lakes)
# TRUE is now returned
```

```{r, Ch11-micromap-oregon-lakes, eval = FALSE, echo = FALSE, fig.cap = 'Combining Oregon Border and Oregon Lakes'}
ggplot() + 
  geom_sf(data=OR_lakes,  color="blue") +
  geom_sf(data=OR,  color="black", fill=NA) +
  labs(title="Oregon Lakes") +
  theme_bw() 
```

The _OR_lakes_\index{Datasets!OR\_lakes} dataset is the sample frame that will be used with the `grts` function from **spsurvey**\index{R Packages!spsurvey} R package to draw a spatially balanced probabilistic sample. Initially, we get an error message because the sample frame is in  geographic coordinates, latitude and longitude, but instead needs to be in a projected coordinates.  The assignment `OR_lakes <- st_transform(OR_lakes, crs = 5070)` put the sample frame into Albers equal area projected coordinates and then a spatially balanced sample can be drawn.

```{r Ch11-micromap-spsurvey-error, eval = FALSE, echo = FALSE}
# an equal probability sample draw of 50 lakes
set.seed(20220502)
eqprob <- grts(OR_lakes, n_base = 50)
# look at error message
stop_df
# rm(eqprob)
```

```{r Ch11-micromap-crs-check2, eval = FALSE, echo = FALSE}
OR_lakes <- st_transform(OR_lakes, crs = 5070)
OR_lakes
```

```{r, Ch11-micromap-spsurvey-correct, eval = FALSE, echo = FALSE, fig.show = 'hold', fig.cap = 'Oregon Lakes Sample Frame & Equal Probability Sites in Projected Coordinates'}

set.seed(20220502)
eqprob <- grts(OR_lakes, n_base = 50)

head(eqprob$sites_base)

eqprob_base <- eqprob$sites_base

OR <- st_transform(OR, st_crs(eqprob_base))

OR_lakes <- st_transform(OR_lakes, st_crs(eqprob_base))

ggplot() + 
  geom_sf(data=OR_lakes, color = "blue") +
  geom_sf(data=eqprob_base,  color="red") +
  geom_sf(data=OR,  color="black", fill=NA) +
  labs(title="Oregon Lakes Sample Frame & GRTS Equal Probability Sites") +
  theme_bw() 

```

The survey designs by VDEQ and FDEP that led to the linked micromaps, Figure \@ref(fig:Ch11-micromapVDEQ) and Figure \@ref(fig:Ch11-micromapFDEP), were more sophisticated than the example of an equal probability draw.  Using a spatially balance probabilistic survey drawn from **spsurvey**\index{R Packages!spsurvey} has two advantages.  First, from a design perspective, one obtains a good spatial coverage of the features to be sampled.  As @OKP2012 noted, users designing a spatially balanced survey often underestimate the effort required to build a single GIS layer having all the attributes needed for such a design.  Second, from an analytical perspective, a local neighborhood variance estimator is used, which outperforms other alternatives, by providing smaller variances, and consequently confidence limits, around the estimated means, totals, percentiles, and cumulative distribution functions from the survey [@SO2004; @OKP2012]. This advantage of the local neighborhood variance estimator over an independent random sample variance estimator has been shown in a river and stream survey estimates of a fish community index of biotic integrity and a qualitative habitat evaluation index, and in a reservoir survey estimates of methane emission rates, which is a greenhouse gas [@SO2004; @BMN2016].  Consequently, in a linked micromap of spatially balanced probabilistic survey results one would have smaller confidence limits displayed around the means or percentiles because of this effect of the local neighborhood variance estimate.

## Further Reading {#Ch11-FurtherReading}


Introduce cross-references to other chapters, e.g., Chapter \@ref(Ch1) and Chapter \@ref(Ch2),
where related work and further examples can be found in this book that match the content of this
chapter, that follow up on this chapter, or that are a prerequisite of this chapter.

Also, do some scientific literature review here that is specific to your chapter.
Where has this R package been introduced and used before, where have other plot types
or different countries been used in micromaps, what were other applications 
of micromaps that are related to the title and content of your chapter, etc.?


\printbibliography[segment=\therefsegment,heading=subbibliography]

