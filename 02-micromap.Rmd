# Linked Micromap Plots via the **micromap** R Package {#Ch2}


\chapterauthor{J{\"u}rgen Symanzik, Marcus W. Beck, Michael G. McManus}


The **micromap**\index{R Packages!micromap} R package [@PaOl2015],
accessible at https://cran.r-project.org/web/packages/micromap/index.html,
will be introduced in this chapter. The reader will learn how to create a 
basic linked micromap plot\index{Linked micromap plot} via this R package. 
Details will be provided how to optimize and fine-tune such a basic plot 
into a publication-worthy final linked micromap plot.


## Introduction {#Ch2-Introduction}


Write chapter introduction here.


## Chapter Outline (Merge into Chapter Introduction at the End) {#Ch2-Outline}


Note: Chapter \@ref(Ch1) will cover elements of a linked micromaps, 4 panels of legend, label, statistic, micromaps 
and rows of perceptual groups? Also discussion of spatial patterns and interpretation of positive, negative
(or no) association in statistical panels of dotplots.\index{Dotplot}


-	Overview of Four Steps (**Marcus**: Maybe a good figure could be a conceptual diagram showing the whole process?)
    - Identifying and Geoprocessing of Spatial Boundary Data
    - Linking Spatial Boundary Data and Statistical Data
    - Creating a Draft Linked Micromap Plot
    - Refining the Linked Micromap Plot
    
-	Spatial Polygons in R and micromap Package Updates (**Juergen**: How much of this do we need here in Chapter \@ref(Ch2)? Would it make more sense to mention this in Chapter \@ref(Ch4)?)
    - Spatial objects and simple feature objects
    - Updates
    
-	Identifying and Geoprocessing of Spatial Boundary Data (**Marcus**: I think this is a good topic to discuss, but may be tricky to balance specificity with brevity.  I'm no expert on it, but I know there are a few different methods one could use.  Maybe just hit on the why and how, and briefly present tradeoffs of the different methods?  I think for MM, the goal is just to increase render time w/o sacrificing spatial specificity, so maybe the exact method is not important? -- **Juergen**: In fact, let's keep it simple here and work with ready-to-use shapefiles that are already available in some R packages; refer to Chapter \@ref(Ch4) how to bring in external shapefiles and modify them for use in micromaps)
    - Keep this brief as Chapter \@ref(Ch4) might cover this in detail?
    - Example of generalizing polygons Figure  (Use same figures as Chapter \@ref(Ch4)?)

-	Linking Spatial Boundary Data and Statistical Data
    - Explicit link to spatial object
    - Under the hood link to simple features object

-	Creating a Draft Linked Micromap Plot
    - Use workshop NARS pH sample & population estimates Figure (**Juergen**: Use simpler edPov data in first example)

-	Refining the Linked Micromap Plot
    - Use workshop NARS pH sample & population estimates Figure (**Juergen**: Use simpler edPov data in first example)

- **Juergen**: Introducing a second basic example for a different geographic region, e.g., state level or environmental, and use of a different built-in plot type (e.g., boxplot). Similar four steps as before, but more condensed.

-	Challenges to Visualizing Data with Linked Micromap Plots (**Marcus**: Not sure this is the right place for it, but maybe it's worth providing a brief contrast with micromapST?  Maybe include this in the overview at the top?  I think it would be useful for the reader to understand succinctly how the two differ and why there are two packages, though I'm sure these themes will be present throughout the book.  Perhaps the latter point is not that interesting, i.e., it's common to have "competing" software in an open source environment? -- **Juergen**: Yes, we need some discussions at the end of Chapters \@ref(Ch2) and \@ref(Ch3) that outline advantages and limitations of each of the two main micromap packages. Alternatively, there could be some table in Chapter \@ref(Ch1) that lists features (and limitations) of the two packages when they are first introduced to the reader. Overall, this last point may be a subsection in the Introduction, or become a final chapter at the end of the book which research is necessary in the future.)
    - Problem of many polygons (**Juergen**: There are other problems, e.g., many islands as in the Philippines, narrow shapes as for Chile, subregions of considerably different sizes as for Russia)
    - Automating linked micromap plot production for reports and interactive visualizations (Check with Emma Jones at VA DEQ)
    - (**Marcus**: Related, a disadvantage of both packages is their lack of tighter integration with ggplot.  Not sure we want to go there though. -- **Juergen**: I wouldn't go there as these are the packages that currently exist and have to be used.)


## Steps to Create a Linked Micromap Plot with the **micromap**\index{R Packages!micromap} R Package {#Ch2-Steps}


Four main steps, shown in Figure \@ref(fig:Ch2-flowchart), are needed to create a 
linked micromap plot\index{Linked micromap plot} 
with the **micromap**\index{R Packages!micromap} R package:

1. **Identifying and Geoprocessing of Spatial Boundary Data** 
(see Sections \@ref(Ch2-Identifying) and \@ref(Ch2-IdentifyingWV) for details): 
In addition to a data frame that contains the statistical data,
the user must identify a data structure that contains the spatial boundary data for the region and subregions that have
to be colored in the maps. This spatial boundary data typically comes in the form of a
SpatialPolygonsDataFrame\index{SpatialPolygonsDataFrame}. In this chapter, we will work with ready-to-use
boundary files. In Chapter \@ref(Ch4), we will discuss how to make use of boundary files that are
provided as external shapefiles\index{Shapefiles}. In particular, we will see in that chapter how
to simplify complex boundaries, enlarge small subregions in the maps, and move subregions that are far away closer
to the main area of the map.

2. **Linking Spatial Boundary Data and Statistical Data** 
(see Sections \@ref(Ch2-Linking) and \@ref(Ch2-LinkingWV) for details): 
To link spatial boundary data and statistical data, 
the SpatialPolygonsDataFrame\index{SpatialPolygonsDataFrame} first has to be transformed into a regular data frame
via the `micromap::create_map_table()` function.
Next, we have to identify one variable from the statistical data frame
and one variable from the newly created data frame with the boundary information that 
allow us to link statistical data and boundary data for each subregion.

3. **Creating a Draft Linked Micromap Plot** 
(see Sections \@ref(Ch2-Creating) and \@ref(Ch2-CreatingWV) for details): 
While not necessary, it is always a good idea to first create a minimal
linked micromap plot\index{Linked micromap plot} to ensure that the statistical data and boundary data
are matching and a correct draft linked micromap plot\index{Linked micromap plot} is created. Skipping this
step and trying to create a complex linked micromap plot\index{Linked micromap plot} immediately may make it hard
to find possible errors in the R code.

4. **Refining the Linked Micromap Plot** 
(see Sections \@ref(Ch2-Refining) and \@ref(Ch2-RefiningWV) for details): 
Once a draft linked micromap plot\index{Linked micromap plot} has been
created, this plot usually needs fine-tuning of its appearance and plot aesthetics, e.g., modification of colors,
change of the layout and of perceptual groups, addition of labels and legends, and possibly the addition of additional
statistical variables or changes to different graph types for some of the variables.


```{r Ch2-flowchart, fig.cap = 'Workflow to create a linked micromap plot with the **micromap**\\index{R Packages!micromap} R package (Diagram created with the **DiagrammeR**\\index{R Packages!DiagrammeR} R package [@Iannone2022]).', fig.width = 5, fig.height = 5, echo = FALSE}
library(DiagrammeR)

DiagrammeR::grViz(
  diagram = "digraph flowchart {
  node [fontname = arial, shape = oval, color = grey, style = filled]
  tab1 [label = '@@1']
  tab2 [label = '@@2']
  tab3 [label = '@@3']
  tab4 [label = '@@4']

  tab1 -> tab2 -> tab3 -> tab4;
}

  [1]: '1. Identifying and Geoprocessing of Spatial Boundary Data'
  [2]: '2. Linking Spatial Boundary Data and Statistical Data'
  [3]: '3. Creating a Draft Linked Micromap Plot'
  [4]: '4. Refining the Linked Micromap Plot'
"
)
```


## Example 1: A Linked Micromap Plot for the 50 US States and Washington, D.C. {#Ch2-Example1}


In this first linked micromap plot\index{Linked micromap plot}
example created with the **micromap**\index{R Packages!micromap} R package, we work with the
_USstates_\index{Datasets!USstates} and _edPov_\index{Datasets!edPov} datasets
from the **micromap**\index{R Packages!micromap} R package.
We follow the four steps outlined in Section \@ref(Ch2-Steps).


### Identifying and Geoprocessing of Spatial Boundary Data {#Ch2-Identifying}


_USstates_\index{Datasets!USstates} is a SpatialPolygonsDataFrame\index{SpatialPolygonsDataFrame} for 
the 50 states (and Washington, D.C.) of the United States (U.S.) 
that was created for use in linked micromap plots\index{Linked micromap plot}. Notably, the boundaries
of many of the states have been simplified, Alaska and Hawaii have been moved closer to the
contiguous 48 states (and also have been resized), and Washington, D.C., has been pulled out of the
main map and has been placed further to the east (and also has been enlarged)
as shown in Figure \@ref(fig:Ch2-USstates). In the following R code,
we first load the **micromap**\index{R Packages!micromap} R package and the
_USstates_\index{Datasets!USstates} data set, verify that this object indeed is a
SpatialPolygonsDataFrame\index{SpatialPolygonsDataFrame}, then look
at some of the data in the `data` component of this object, and finally plot it.
For figures that only contain maps, it is often helpful to remove all 
margin space on all four sides of the plot 
via `par(mar = c(0, 0, 0, 0))`
to maximize the plot, i.e., the actual map.
The reader will notice that the **micromap**\index{R Packages!micromap} R package
depends on the **maptools**\index{R Packages!maptools} [@BiLe2014], 
**RColorBrewer**\index{R Packages!RColorBrewer} [@Neuwirth2022], 
**rgdal**\index{R Packages!rgdal} [@BKR2022], 
**sp**\index{R Packages!sp} [@PeBi2022], 
and **sf**\index{R Packages!sf} [@Pebesma2022] R packages
and also suggests the use of the **rgeos**\index{R Packages!rgeos} [@BiRu2021]
R package. All of these R packages should
be installed locally so they can be loaded automatically when the
**micromap**\index{R Packages!micromap} R package is loaded.


```{r Ch2-USstates, fig.cap = 'Map representation of the _USstates_\\index{Datasets!USstates} spatial boundary data set for the United States that frequently is used as the basis for linked micromap plots\\index{Linked micromap plot} that are created with the **micromap**\\index{R Packages!micromap} R package.', fig.width = 7, fig.height = 4}
library(micromap)

data(USstates)

class(USstates)
head(USstates@data)

par(mar = c(0, 0, 0, 0))
plot(USstates)
```


### Linking Spatial Boundary Data and Statistical Data {#Ch2-Linking}


In this step, the SpatialPolygonsDataFrame\index{SpatialPolygonsDataFrame} first is transformed
into a regular data frame for use in a linked micromap plot\index{Linked micromap plot}
via the `micromap::create_map_table()` function. We have to indicate a variable from the `data`
component of the SpatialPolygonsDataFrame\index{SpatialPolygonsDataFrame} object that 
can be used as an ID column. 
A matching ID column has to be identified in the statistical dataset. These two ID columns
have to be used for linking the two data sets. For the _USstates_\index{Datasets!USstates} dataset,
this is usually the `ST` variable that contains the 51 abbreviations for the 50 US states (and for Washington, D.C.).


```{r Ch2-linkingdataframesUSstates}
head(USstates@data$ST)

state_polys_table <- create_map_table(
  tmp.map = USstates,
  IDcolumn = "ST"
)

class(state_polys_table)
dim(state_polys_table)
names(state_polys_table)
```


The resulting `state_polys_table` is a regular data frame that will be used for creating a
linked micromap plot\index{Linked micromap plot} in the next step.
`state_polys_table` consists of `r dim(state_polys_table)[1]` rows. This implies that the map is based
on `r dim(state_polys_table)[1]` line segments.

_edPov_\index{Datasets!edPov} is a data frame that contains
education and poverty level data for the 50 states (and Washington, D.C.).
This data frame has 51 rows, one for each of the 50 states (and one for Washington, D.C.).
We have to identify one variable from this data frame that can be used for linking the
two data sets. Here, this is the `StateAb` variable.

The last expression in the following R code verifies that there is indeed at least one matching ID 
in the `state_polys_table` data frame for each ID in the _edPov_\index{Datasets!edPov} dataset.
Mismatching or missing IDs in the statistical data frame may cause
that data for some subregions do not appear
on any of the maps later on or that some subregions shown on the maps do not get colored in any of the maps.
While this often can be contributed to missing data in the statistical data frame, e.g., there is
only data for the 50 states but not for Washington, D.C., mismatching identifiers also can be
the underlying reason (e.g., if the statistical data frame uses `D.C.` as ID while
the spatial data frame uses `DC`). Here, everything is matching.


```{r Ch2-linkingdataframesedPov}
data(edPov)
dim(edPov)

head(edPov)
head(edPov$StateAb)

all(sort(edPov$StateAb) == sort(unique(state_polys_table$ID)))
```


### Creating a Draft Linked Micromap Plot {#Ch2-Creating}


Now we can create a minimal draft linked micromap plot\index{Linked micromap plot} using the
`micromap::mmplot()` function, based on the previously created 
`state_polys_table` data frame and the _edPov_\index{Datasets!edPov} dataset.
In our function call, we only provide seven required arguments. None of these arguments has a default setting.
For all other arguments of this function, the default settings will be used here. 
The statistical data (_edPov_\index{Datasets!edPov}) is assigned to the `stat.data` argument
and the spatial boundary data (in the `state_polys_table` data frame) is assigned to the `map.data` argument.

The `map.link` argument is needed to tell the function how to link the statistical data
and the spatial boundary data. A vector with the names of the two linking variables 
identified in the previous step is needed for this argument.
The first variable name (`StateAb`) must come from the statistical data (here _edPov_\index{Datasets!edPov})
and the second variable name (`ID`) must come from the `state_polys_table` data frame that
contains the spatial boundary information.
Changing the order of these two variable names typically results in an error.

The `panel.types` and `panel.data` arguments are closely related. 
As the name suggests, `panel.types` is a vector
that specifies the layout of the columns in the linked micromap plot\index{Linked micromap plot}.
Here, we have a `dot_legend` in the first column, `labels` in the second column,
the statistical data represented as dotplots\index{Dotplot} (`dot`) in the third and fourth columns,
and the micromaps in the fifth, i.e., final, (`map`) column.
This is matched with a list of data that is used for each of the five columns.
A list is necessary for this argument as some of the data itself can be lists as we will
see in the R code for Figures \@ref(fig:Ch2-refining1WV) 
and \@ref(fig:Ch2-refining2WV) later on.

The `dot_legend` simply shows a plotting symbol in a certain color that represents that row in
the linked micromap plot\index{Linked micromap plot}. Thus, no further data is needed and `NA`
is assigned. `labels` requires some text argument, typically some identifiers of the subregions
in the maps. Here `state` from _edPov_ is used. 
The variables `pov` and `ed` from _edPov_ are used for the statistical displays in columns three and four.
It should be noted that all data specified in `panel.data` by default is taken from the
data frame specified in the `stat.data` argument.
The fifth and final column contains the micromaps. Their boundaries are obtained from
the `map.data` data frame. Thus, no further data has to be specified here. Instead, `NA` 
is assigned here.

Two more arguments have to be specified: `ord.by` specifies the sorting variable of the 
rows in the linked micromap plot\index{Linked micromap plot}. Here, `pov` 
from the `stat.data` argument is used. The sorting of the rows goes from smallest (on top) to
largest (at the bottom). Finally, `grouping` specifies  the number of rows
in each of the perceptual groups. If a single integer value is provided, 
that value is used for all perceptual groups. If a vector of integer values is provided,
each perceptual group may have a different number of rows as 
shown in the R code for Figure \@ref(fig:Ch2-refining3). 
Here, `grouping` is set to `5`, meaning there are five rows of data in each perceptual group.

The resulting draft linked micromap plot\index{Linked micromap plot} is shown in
Figure \@ref(fig:Ch2-creatingdraft). It is noteworthy that there are eleven perceptual groups
overall --- ten with five subregions and one with just one subregion. This is due to the fact
that there are 51 subregions overall: The 50 US states and Washington, D.C.
This results in only one row of data and one subregion highlighted in the final (bottom) perceptual
group. There is no automatic balancing of the number of rows in each perceptual group.
A layout such as the default one shown in Figure \@ref(fig:Ch2-creatingdraft) 
should be avoided in general. Table XXX in Chapter \@ref(Ch1) provides 
suggestions how to group data for various numbers of subregions.
We will also address this as one of the refinement steps in the next section.

We abstain from interpreting this figure at this stage, but we will provide some
helpful interpretation once we have created the last refined version of this figure
at the end of the next section. However, we encourage the reader to take a look
at the consecutive maps at this time and determine whether any spatial
patterns may be visible and to assess the statistical relationship
between the two variables shown in the third and fourth columns of the plot.


```{r Ch2-creatingdraft, fig.cap = 'Draft linked micromap plot\\index{Linked micromap plot}, based on the _edPov_\\index{Datasets!edPov} dataset.', fig.width = 7, fig.height = 9}
mmplot(
  stat.data = edPov,
  map.data = state_polys_table,
  map.link = c("StateAb", "ID"),
  panel.types = c("dot_legend", "labels", "dot", "dot", "map"),
  panel.data = list(NA, "state", "pov", "ed", NA),
  ord.by = "pov",
  grouping = 5
)
```


### Refining the Linked Micromap Plot {#Ch2-Refining}


We continue with the draft linked micromap plot\index{Linked micromap plot} from the previous
section and refine it in multiple small steps. This refinement process should only be started once
functional R code has been obtained in the previous step and an initial 
linked micromap plot\index{Linked micromap plot} has been created.

First, we get rid of the eleventh perceptual group (with just one subregion) and introduce
a median row via `median.row = TRUE` instead. A median row is often a good solution if the 
number of subregions is odd such as for the 50 states (and Washington, D.C.).
Here, Wyoming is the state shown in the median row. It has the 
26$^{th}$ highest (or lowest) value for the sorting variable, i.e., `pov`.
It does not appear in a map by itself, but rather is added to the perceptual
groups above and below the median row in a neutral color, 
thus increasing the number of subregions shown in each of these two maps by one (i.e., six here).
Also, we reverse the sorting order via `rev.ord = TRUE`. 
Now the sorting of the rows goes from largest (on top) to
smallest (at the bottom).
The resulting linked micromap plot\index{Linked micromap plot} is shown in
Figure \@ref(fig:Ch2-refining1).
While we keep `pov` as the sorting variable in this first refined version,
the reader is encouraged to use `ed` as sorting variable and see how
the spatial patterns highlighted in the maps change. This can be done
for the original sorting order or for the reversed sorting order.
The rows can even be sorted by `region` or alphabetically 
by `state` or `StateAb` even though such an alphabetical sorting
in most cases is not very meaningful, at least not for this specific example.


```{r Ch2-refining1, fig.cap = 'First refined linked micromap plot\\index{Linked micromap plot}, based on the _edPov_\\index{Datasets!edPov} dataset. Main changes are the introduction of a median row instead of the eleventh perceptual group and the reverse ordering of the `pov` data in the first statistical graphics column.', fig.width = 7, fig.height = 9}
mmplot(
  stat.data = edPov,
  map.data = state_polys_table,
  map.link = c("StateAb", "ID"),
  panel.types = c("dot_legend", "labels", "dot", "dot", "map"),
  panel.data = list(NA, "state", "pov", "ed", NA),
  ord.by = "pov",
  rev.ord = TRUE,
  grouping = 5,
  median.row = TRUE
)
```


We continue with this first refined linked micromap plot\index{Linked micromap plot}
and make further modifications. Next, we change the order of the two statistical graphics columns,
i.e., we place `ed` to the left of `pov` and use `ed` as the sorting variable (in reverse order).
While any column of the linked micromap plot\index{Linked micromap plot} or even
variables not shown in it can be used as sorting variables, in most cases,
the first (leftmost) statistical graphics column is used for sorting purposes.
Moreover, we place the maps on the left side of the plot. As previously stated,
the `panel.types` and `panel.data` arguments of the `micromap::mmplot()` function
are closely related. Thus, if we change the order of one, the order of the
other one has to be changed accordingly. 
The resulting linked micromap plot\index{Linked micromap plot} is shown in
Figure \@ref(fig:Ch2-refining2).
There is no strong recommendation where the column with the maps should be placed.
This often depends on personal preferences of the authors.
There exist examples in the literature where the maps are placed on the left,
e.g., in @Mast2013LinkedMicromaps and @DaWo2021, 
on the right, 
e.g., in @Wartenberg2009,
and even in the middle,
e.g., in @TaSt2019.


```{r Ch2-refining2, fig.cap = 'Second refined linked micromap plot\\index{Linked micromap plot}, based on the _edPov_\\index{Datasets!edPov} dataset. Main changes are related to the order of the five columns in the plot. Most notable, the map column is shown on the left here.', fig.width = 7, fig.height = 9}
mmplot(
  stat.data = edPov,
  map.data = state_polys_table,
  map.link = c("StateAb", "ID"),
  panel.types = c("map", "dot_legend", "labels", "dot", "dot"),
  panel.data = list(NA, NA, "state", "ed", "pov"),
  ord.by = "ed",
  rev.ord = TRUE,
  grouping = 5,
  median.row = TRUE
)
```


We continue making changes to the second refined linked micromap plot\index{Linked micromap plot}.
We change the grouping to nine perceptual groups overall (and no median row)
via `grouping = c(6, 6, 6, 6, 3, 6, 6, 6, 6)` and `median.row = FALSE`
and vertically align the rows in each perceptual block via `vertical.align = "center"`.
Finally, we start making changes to individual columns of the plot via
the `panel.att` argument. Here, the third column that shows the `labels` is aligned on the left.
The resulting linked micromap plot\index{Linked micromap plot} is shown in
Figure \@ref(fig:Ch2-refining3).


```{r Ch2-refining3, fig.cap = 'Third refined linked micromap plot\\index{Linked micromap plot}, based on the _edPov_\\index{Datasets!edPov} dataset. Main changes are related to perceptual groups with different numbers of subregions and the vertical alignment of rows in the middle of the plot. Also, `labels` are aligned on the left.', fig.width = 7, fig.height = 9}
mmplot(
  stat.data = edPov,
  map.data = state_polys_table,
  map.link = c("StateAb", "ID"),
  panel.types = c("map", "dot_legend", "labels", "dot", "dot"),
  panel.data = list(NA, NA, "state", "ed", "pov"),
  ord.by = "ed",
  rev.ord = TRUE,
  grouping = c(6, 6, 6, 6, 3, 6, 6, 6, 6),
  median.row = FALSE,
  vertical.align = "center",
  panel.att = list(list(3, align = "left"))
)
```


After this experiment with a different grouping, we revert back to the more traditional grouping
of ten perceptual groups with five rows each and a median row that is frequently used
for the 50 US states (and Washington, D.C.). What we want to discuss next is the choice of colors
for the subregions in each map (and thus for the `dot_legend` appearance in the
`panel.type` argument as well). The default setting for the `colors` argument
makes use of `max(grouping)` different colors from a spectral color scheme.
Thus, when `grouping = 5` as in Figures \@ref(fig:Ch2-creatingdraft)-\@ref(fig:Ch2-refining2),
a five-class spectral color scheme\index{Color scheme!Spectral} is selected, 
whereas a six-class spectral color scheme\index{Color scheme!Spectral} is
selected when `grouping = c(6, 6, 6, 6, 3, 6, 6, 6, 6)` as in Figure \@ref(fig:Ch2-refining3).
Historically, many linked micromap plots,\index{Linked micromap plot} 
e.g., in @COCPC1998 and @WCCBP2002,
made use of rainbow colors\index{Color scheme!Rainbow colors} that could be obtained 
via the `colors = c("red", "orange", "green", "blue", "purple")` setting of the
`colors` argument. While these colors work well for readers with normal color vision,
they may not work well for readers with certain types of color vision deficiencies.
Instead, some color schemes that are colorblind safe are better suited for such readers.
Options are single-hue or multi-hue sequential color schemes\index{Color scheme!Sequential} 
or selected divergent color schemes\index{Color scheme!Divergent}.
Such color schemes can be obtained from the 
**RColorBrewer**\index{R Packages!RColorBrewer} R package [@Neuwirth2022].
The reader is encouraged to read more about the theoretical background
of these color schemes in @BHH2003 and @HaBr2003 and experiment with different settings
at the supporting web page at https://colorbrewer2.org/.
@SDWPM2014 used a five-class greyscale sequential color scheme\index{Color scheme!Sequential}
from **RColorBrewer**\index{R Packages!RColorBrewer} in reverse sorting (where
the darkest grey color comes first) for publication in a greyscale publication,\index{Colors!Greyscale publication}
obtained via `colors = RColorBrewer::brewer.pal(n = 5, name = "Greys")[5:1]`.
@SBDSS2016 used a five-class divergent red-yellow-blue (RdYlBu) color scheme\index{Color scheme!Divergent}
from **RColorBrewer**\index{R Packages!RColorBrewer}
that is colorblind safe\index{Colors!Colorblind safe} and print friendly,\index{Colors!Print friendly}
obtained via `colors = RColorBrewer::brewer.pal(n = 5, name = "RdYlBu")`.
In the linked micromap plot\index{Linked micromap plot} shown in
Figure \@ref(fig:Ch2-refining4), we use a
five-class divergent brown-blue-green (BrBG) color scheme\index{Color scheme!Divergent}
from **RColorBrewer**\index{R Packages!RColorBrewer}
that is also colorblind safe\index{Colors!Colorblind safe} and print friendly,\index{Colors!Print friendly}
obtained via `colors = RColorBrewer::brewer.pal(n = 5, name = "BrBG")`.


```{r Ch2-refining4, fig.cap = 'Fourth refined linked micromap plot\\index{Linked micromap plot}, based on the _edPov_\\index{Datasets!edPov} dataset. Main changes are the use of a divergent brown-blue-green color scheme\\index{Color scheme!Divergent} and the conversion back to the traditional grouping for 51 subregions.', fig.width = 7, fig.height = 9}
mmplot(
  stat.data = edPov,
  map.data = state_polys_table,
  map.link = c("StateAb", "ID"),
  panel.types = c("map", "dot_legend", "labels", "dot", "dot"),
  panel.data = list(NA, NA, "state", "ed", "pov"),
  ord.by = "ed",
  rev.ord = TRUE,
  grouping = 5,
  median.row = TRUE,
  colors = RColorBrewer::brewer.pal(n = 5, name = "BrBG"),
  panel.att = list(list(3, align = "left"))
)
```


So far, there are no labels for the columns and no titles for the statistical graphics columns shown.
Tic marks and tic mark labels, in particular in the second statistical graphics column, could be improved,
background colors in the statistical graphics columns and maps could be modified, 
font and symbol sizes could be modified, and the widths of the columns could be adjusted.
All of this is done via the `panel.att` argument that controls the panel specific attributes of
each column in the linked micromap plot.\index{Linked micromap plot}
The content of this argument typically is a list of lists where the attributes
for each column of the linked micromap plot\index{Linked micromap plot} are modified via a separate list.
These inner lists are numbered from 1 to the number of elements in the `panel.types` vector
where `1` is related to `map`, `2` to `dot_legend`, `3` to `labels`, and `4` and `5` to `dot`, i.e.,
the dotplots\index{Dotplot} in the two statistical graphics columns,
in the linked micromap plot\index{Linked micromap plot} shown in
Figure \@ref(fig:Ch2-refining5).

We leave it to the reader to further experiment with the different elements in these lists.
If the purpose of a certain element is not immediately obvious, it might be a good idea
to considerably increase or decrease the numeric value of that element or change the color to
`red` or `yellow` to highlight that element. 

Here, we only want to explain the purpose of the `fill.regions` element with the matching `header` element
in the list for column `1`, i.e., the `map` column:
The setting `fill.regions = "aggregate"` (which in fact is the default setting)
fills in the subregions from all previous perceptual groups in the
subsequent perceptual groups. This filing proceeds from
the top perceptual group to the bottom perceptual group by sequentially
filling the subregions that have already been displayed.
Thus, in the map for the final perceptual group at the bottom, all subregions have been filled.
The text in the `header` is used to communicate this information to the reader.
Alternatively, the setting `fill.regions = "with data"` only fills those subregions
in a map that actually show data in that perceptual group. 
No additional subregions are filled in any of the maps.
Another setting for `fill.regions` is discussed in the next refinement step.


```{r Ch2-refining5, fig.cap = 'Fifth refined linked micromap plot\\index{Linked micromap plot}, based on the _edPov_\\index{Datasets!edPov} dataset. Main changes are related to the panel specific attributes.', fig.width = 7, fig.height = 9}
mmplot(
  stat.data = edPov,
  map.data = state_polys_table,
  map.link = c("StateAb", "ID"),
  panel.types = c("map", "dot_legend", "labels", "dot", "dot"),
  panel.data = list(NA, NA, "state", "ed", "pov"),
  ord.by = "ed",
  rev.ord = TRUE,
  grouping = 5,
  median.row = TRUE,
  colors = RColorBrewer::brewer.pal(n = 5, name = "BrBG"),
  panel.att = list(
    list(
      1,
      header = "Light Gray Means\nPreviously Displayed",
      map.all = TRUE,
      fill.regions = "aggregate",
      active.border.color = "black",
      active.border.size = 1.2,
      inactive.border.color = gray(0.7),
      inactive.border.size = 1,
      panel.width = 0.8
    ),
    list(
      2,
      point.type = 20,
      point.border = TRUE,
      point.size = 2,
      panel.width = 0.9
    ),
    list(
      3,
      header = "States",
      align = "left",
      text.size = 0.9,
      panel.width = 0.7
    ),
    list(
      4,
      header = "Percent Adults With\n4+ Years of College",
      graph.bgcolor = "lightgray",
      point.size = 1.5,
      xaxis.ticks = list(10, 20, 30, 40),
      xaxis.labels = list(10, 20, 30, 40),
      xaxis.title = "Percent"
    ),
    list(
      5,
      header = "Percent Living Below\nPoverty Level",
      graph.bgcolor = "lightgray",
      point.size = 1.5,
      xaxis.ticks = list(5, 10, 15, 20),
      xaxis.labels = list(5, 10, 15, 20),
      xaxis.title = "Percent"
    )
  )
)
```


In the final refined linked micromap plot\index{Linked micromap plot} shown in
Figure \@ref(fig:Ch2-refining6), we make three more types of changes.
First, we make use of the `labeling::extended()` function of 
the **labeling**\index{R Packages!labeling} R package [@Talbot2020].
This function is provided with the minimum and maximum values of a variable and the tentative
number of tic marks and tic marks labels for that variable and it then creates a vector with
near-optimal axis labels. The argument `m` is used as a guideline for the number of axis labels,
but the actual number of near-optimal axis labels may differ slightly. The reader is encouraged to experiment with
`m = 2` to `m = 6` in the R code below.

Second, we use the setting `fill.regions = "two ended"`. This setting makes most sense when
`median.row = TRUE` (as is the case here) and the focus of the maps is to 
indicate which subregions are above or below the median value
of the variable specified in the `ord.by` argument (here `ed`).
Similar to the setting `fill.regions = "aggregate"`,
the subregions from all previous perceptual groups are filled in the
subsequent perceptual groups. This filling proceeds from
the top perceptual group to the median row 
and from the bottom perceptual group to the median row
by sequentially
filling the subregions that have already been displayed on the more extreme ends.
The text in the `header` has been updated to communicate this information to the reader.

Third, we reduce the margin space between some of the columns via the
`right.margin` and `left.margin` settings. Negative values are allowed.
Fine-tuning the margin spacing and the widths of the columns can require
a few iterations. The reader always should check carefully that no identifiers
are truncated or overprinted, in particular that no letters
from the longest identifier (here `Washington D.C.`) are cut off.


```{r Ch2-refining6, fig.cap = 'Sixth (and final) refined linked micromap plot\\index{Linked micromap plot}, based on the _edPov_\\index{Datasets!edPov} dataset. Main changes are related to labeling, the coloring of perceptual groups above and below the median row, and the column spacing.', fig.width = 7, fig.height = 9}
library(labeling)

mmplot(
  stat.data = edPov,
  map.data = state_polys_table,
  map.link = c("StateAb", "ID"),
  panel.types = c("map", "dot_legend", "labels", "dot", "dot"),
  panel.data = list(NA, NA, "state", "ed", "pov"),
  ord.by = "ed",
  rev.ord = TRUE,
  grouping = 5,
  median.row = TRUE,
  colors = RColorBrewer::brewer.pal(n = 5, name = "BrBG"),
  panel.att = list(
    list(
      1,
      header = "Two-ended\nCumulative Maps",
      map.all = TRUE,
      fill.regions = "two ended",
      active.border.color = "black",
      active.border.size = 1.2,
      inactive.border.color = gray(0.7),
      inactive.border.size = 1,
      panel.width = 0.8
    ),
    list(
      2,
      point.type = 20,
      point.border = TRUE,
      point.size = 2,
      panel.width = 0.9
    ),
    list(
      3,
      header = "States",
      align = "left",
      right.margin = 0,
      left.margin = -1,
      text.size = 0.9,
      panel.width = 0.6
    ),
    list(
      4,
      header = "Percent Adults With\n4+ Years of College",
      graph.bgcolor = "lightgray",
      right.margin = 0,
      left.margin = -0.6,
      point.size = 1.5,
      xaxis.ticks = as.list(labeling::extended(
        dmin = min(edPov$ed),
        dmax = max(edPov$ed),
        m = 5
      )),
      xaxis.labels = as.list(labeling::extended(
        dmin = min(edPov$ed),
        dmax = max(edPov$ed),
        m = 5
      )),
      xaxis.title = "Percent"
    ),
    list(
      5,
      header = "Percent Living Below\nPoverty Level",
      graph.bgcolor = "lightgray",
      right.margin = 0.25,
      left.margin = -0.6,
      point.size = 1.5,
      xaxis.ticks = as.list(labeling::extended(
        dmin = min(edPov$pov),
        dmax = max(edPov$pov),
        m = 4
      )),
      xaxis.labels = as.list(labeling::extended(
        dmin = min(edPov$pov),
        dmax = max(edPov$pov),
        m = 4
      )),
      xaxis.title = "Percent"
    )
  )
)
```


What remains to be done is a summary and interpretation of the 
final refined linked micromap plot\index{Linked micromap plot} shown in Figure \@ref(fig:Ch2-refining6).
This plot shows dotplots of two statistical variables, the percentage of adults with four or more years of college
(in the first statistical graphics column which is the fourth column overall) 
and the percentage living below poverty level (in the second statistical graphics column 
which is the fifth column overall) in the 50 US states and Washington, D.C.

The percentage of adults with four or more years of college is used as the sorting variable
for the rows in the plot -- with highest percentages shown at the top and lowest percentages
shown at the bottom.
The map panel in the first column shows some noticeable, but not very strong spatial patterns.
Highest percentages of adults with four or more years of college can be found in the
northeastern states. In fact, eight of the top-10 states are located in the northeast,
with Washington, D.C., having the highest percentage with almost 40%. When looking at the other
maps above the median state (here, Arizona), additional eastern states, but also several western
states can be seen.
When looking at the two maps at the bottom of the plot, mostly southern states can be seen.
West Virginia is the state with the lowest percentage of only about 15%
of adults with four or more years of college. Overall,
primarily southern and central states can be seen in the maps below the median state.

The percentage living below poverty level (in the fifth column overall) shows a different pattern.
States with a high percentage of adults with four or more years of college have
a low percentage living below poverty level. 
Visually, the dots in the fourth and fifth column diverge, forming some crude caret shape
(resembling an upside down V-shape).
Washington, D.C., is a major outlier as it has the highest 
percentage of adults with four or more years of college (almost 40%)
but also the highest percentage living below poverty level (more than 20%).
Another interesting state is New Mexico with 
an above median percentage of adults with four or more years of college,
but with the fourth highest percentage living below poverty level (about 18%).
As expected, the overall correlation between these two variables is negative,
but given these two major outliers and several minor outliers
(such as Indiana and Nevada that both have a relatively low percentage living below poverty level
despite being among the bottom-10 states with respect to the percentage of
adults with four or more years of college), the (negative) correlation is relatively weak.
The correlation coefficient $r$ is
only about `r round(cor(edPov$ed, edPov$pov), digits = 2)`.


## Example 2: A Linked Micromap Plot for Watersheds in West Virginia {#Ch2-Example2}


In this second linked micromap plot\index{Linked micromap plot}
example created with the **micromap**\index{R Packages!micromap} R package, we work with the
_WV_Watershed_\index{Datasets!WV\_Watershed} dataset
from the **micromapExtra**\index{R Packages!micromapExtra} R package.
We follow the four general steps outlined in Section \@ref(Ch2-Steps) again.
However, there are several differences compared to the first example in Section \@ref(Ch2-Example1).

First, we work with external shapefiles\index{Shapefiles} [@ESRI1998]
that contain both, the boundary for watersheds in West Virginia and the statistical data
used in the following linked micromap plots\index{Linked micromap plot}, rather than having
a separate dataset for the statistical data. 
In general, shapefiles\index{Shapefiles} are a collection of related files 
with the same prefix that contain the geography and attributes (i.e., data) 
of geographically referenced spatial features.
Shapefiles\index{Shapefiles} consist of at least three files: 
a main file that stores the feature geometry (with suffix `.shp`), 
an index file that stores the index of the feature geometry (with suffix `.shx`), 
and a dBASE table that contains the attribute information of the spatial features (with suffix `.dbf`). 
Additional files may be included in a shapefile\index{Shapefiles}. 
Here, for the _WV_Watershed_\index{Datasets!WV\_Watershed} dataset, four additional files are provided:
a file with suffix `.prj` that contains the spatial coordinate system information (i.e., the projection), 
two files with suffix `.sbn` and `.sbx` that store the spatial index of the features,
and a file with suffix `.xml` that contains metadata for the shapefile.
Additional suffixes may be used for a certain shapefile\index{Shapefiles} as outlined in @ESRI2016.

For use in linked micromap plots\index{Linked micromap plot}
that are created with the **micromap**\index{R Packages!micromap} R package,
these external shapefiles\index{Shapefiles} typically are read in as a
SpatialPolygonsDataFrame\index{SpatialPolygonsDataFrame}
and are then split into the geographic information and the statistical data components.
Numerous R packages, such as 
**raster**\index{R Packages!raster} [@Hijmans2022raster],
**rgdal**\index{R Packages!rgdal} [@BKR2022],
**sf**\index{R Packages!sf} [@Pebesma2022],
**shapefiles**\index{R Packages!shapefiles} [@Stabler2022], 
and **terra**\index{R Packages!terra} [@Hijmans2022terra],
support the use of shapefiles\index{Shapefiles} in R.
Only the **raster**\index{R Packages!raster} and **rgdal**\index{R Packages!rgdal}
R packages directly create a SpatialPolygonsDataFrame.\index{SpatialPolygonsDataFrame}
For functions from the other R packages, an additional transformation step would be needed.
The **rgdal**\index{R Packages!rgdal} R package will be retired by the end of 2023.
Therefore, we use the `raster::shapefile()` function here.

It is worthwhile to mention that geography and attributes that are
stored in a simple features\index{Simple features} (sf) format [@OGC2022] instead of a
SpatialPolygonsDataFrame\index{SpatialPolygonsDataFrame}
no longer have to be split. Rather, the **micromap**\index{R Packages!micromap} R package
can handle these directly as can be seen in the R code for Figure \@ref(fig:Ch11-micromapWVDEP).

Moreover, in this example we introduce two new statistical displays
for the statistical graphics columns of the linked micromap plot\index{Linked micromap plot}:
a boxplot\index{Boxplot} and a dotplot with confidence bounds\index{Dotplot with confidence bounds}. 
Different arguments are used to fine-tune this linked micromap plot\index{Linked micromap plot}.
Finally, we will demonstrate how to add an overall statistics (or criteria) line to the 
statistical graphics columns of the linked micromap plot\index{Linked micromap plot}.


### Identifying and Geoprocessing of Spatial Boundary Data {#Ch2-IdentifyingWV}


The _WV\_Watershed_\index{Datasets!WV\_Watershed} dataset
from the **micromapExtra**\index{R Packages!micromapExtra} R package
is stored in external shapefiles\index{Shapefiles} that can be
read in as a SpatialPolygonsDataFrame\index{SpatialPolygonsDataFrame}
via the `raster::shapefile()` function from the
**raster**\index{R Packages!raster} R package [@Hijmans2022raster] 
as discussed in the previous section. It contains
25 aggregated watersheds and subbasins in West Virginia in the United States. 
These watersheds were introduced and discussed in more detail in @MPRG2016.
In addition to the geographic information, this dataset also contains
the statistical information for the linked micromap plots\index{Linked micromap plot} 
created in this section.

Similar to the first example in Section \@ref(Ch2-Identifying), 
we verify that this object (once read into R) indeed is a
SpatialPolygonsDataFrame\index{SpatialPolygonsDataFrame}, then look
at some of the data in the `data` component of this object, and finally plot it,
as shown in Figure \@ref(fig:Ch2-WV).
The last step is the extraction of the statistical data from this
SpatialPolygonsDataFrame\index{SpatialPolygonsDataFrame} into a regular data frame.
This can be done by accessing the data from the `@data` slot in the 
SpatialPolygonsDataFrame\index{SpatialPolygonsDataFrame}.

There are 41 variables in the resulting data frame.
In contrast to @MPRG2016, we will focus on the conductivity variables
in the following linked micromap plots\index{Linked micromap plot}.

Variable names beginning with an uppercase letter, e.g., `Cond_med`, `Cond_LCB95`,
`Cond_UCB95`, are the population estimates, representing the median,
the lower 95% confidence bound, and the upper 95% confidence bound of a variable
(here, conductivity) in each of the 25 watersheds, respectively.
These will be used for the construction of 
dotplots with confidence bounds\index{Dotplot with confidence bounds}.

Variable names starting with a lowercase letter, e.g., 
`cond_min`, `condq1`, `cond_med1`, `cond_q3`, `cond_max`,
are the descriptive statistics, representing the minimum, first quartile, median,
third quartile, and maximum of a variable (here, conductivity) in each of the 25 watersheds, respectively.
These will be used for the construction of boxplots\index{Boxplot}.

(ref:Ch2-WV-cap) Map representation of the _WV_Watershed_\index{Datasets!WV\_Watershed} spatial boundary data set for the 25 watersheds in West Virginia that is used as the basis for the linked micromap plots\index{Linked micromap plot} in this section.


```{r Ch2-WV, fig.cap = '(ref:Ch2-WV-cap)', fig.width = 5, fig.height = 4}
library(raster)

wv_watershed <- raster::shapefile(
  x = "data/WV_Watershed/RandomWatershed2_stats_smooth.shp", 
  verbose = FALSE
)

class(wv_watershed)

head(wv_watershed@data, n = 2)

par(mar = c(0, 0, 0, 0))
plot(wv_watershed)

wv_data <- wv_watershed@data

names(wv_data)
dim(wv_data)
```


### Linking Spatial Boundary Data and Statistical Data {#Ch2-LinkingWV}


Similar to Section \@ref(Ch2-Linking),
the SpatialPolygonsDataFrame\index{SpatialPolygonsDataFrame} first is transformed
into a regular data frame for use in a linked micromap plot\index{Linked micromap plot}
via the `micromap::create_map_table()` function. The `Random_Wat` variable from the `data`
component of the SpatialPolygonsDataFrame\index{SpatialPolygonsDataFrame} object 
can be used as an ID column here. 


```{r Ch2-linkingdataframesWV}
wv_polys_table <- create_map_table(
  tmp.map = wv_watershed,
  IDcolumn = "Random_Wat"
)

head(wv_polys_table)
class(wv_polys_table)
dim(wv_polys_table)
names(wv_polys_table)
```


The resulting `wv_polys_table` is a regular data frame that will be used for creating a
linked micromap plot\index{Linked micromap plot} in the next step.
`wv_polys_table` consists of `r dim(wv_polys_table)[1]` rows. This implies that the map is based
on `r dim(wv_polys_table)[1]` line segments.

We have already extracted the statistical data into the `wv_data` data frame.
Same as for the spatial component, 
the `Random_Wat` variable serves as the linking variable between the two data frames.
As in Section \@ref(Ch2-Linking), we want to verify that there is indeed at least one matching ID 
in the `wv_polys_table` data frame for each ID in the `wv_data` data frame.
In fact, everything is matching here.


```{r Ch2-linkingdataframesWV2}
all(sort(wv_data$Random_Wat) == sort(unique(wv_polys_table$ID)))
```


### Creating a Draft Linked Micromap Plot {#Ch2-CreatingWV}


We can now create a minimal draft linked micromap plot\index{Linked micromap plot} using the
`micromap::mmplot()` function, based on the previously created 
`wv_polys_table` and `wv_data` data frames.
Similar to our first example in Section \@ref(Ch2-Creating),
we only provide seven required arguments in our function call.
None of these arguments has a default setting.
For all other arguments of this function, the default settings will be used here. 
The statistical data (`wv_data`) is assigned to the `stat.data` argument
and the spatial boundary data (in the `wv_polys_table` data frame) is assigned to the `map.data` argument.

The `map.link` argument is needed to tell the function how to link the statistical data
and the spatial boundary data. A vector with the names of the two linking variables 
identified in the previous step is needed for this argument.
As explained in Section \@ref(Ch2-Creating),
the first variable name (`Random_Wat`) must come from the statistical data frame (`wv_data`)
and the second variable name (`ID`) must come from the data frame that
contains the spatial boundary information (`wv_polys_table`).
Changing the order of these two variable names typically results in an error.

As discussed in Section \@ref(Ch2-Creating),
the `panel.types` and `panel.data` arguments are closely related. 
Even though we want to ultimately display boxplots\index{Boxplot} 
and dotplots with confidence bounds\index{Dotplot with confidence bounds} in the
statistical graphics columns of the linked micromap plot,\index{Linked micromap plot}
it often is prudent to start with simple dotplots\index{Dotplot}.
Therefore, we start with these initial settings for the 
`panel.types` vector: We have the `dot_legend` in the first column, `labels` in the second column,
two columns with statistical data represented as dotplots\index{Dotplot} (`dot`)
in the third and fourth columns,
and the micromaps (`map`) in the final fifth column.
This is matched with a list of data that is used for each of the five columns.
Here, we use `Random_Wat` for the second column and `cond_med1` and `Cond_med`
for the third and fourth columns. No further data has to be used for the
first and fifth columns, so `NA` is assigned here.

Two more arguments have to be specified: `ord.by` specifies the sorting variable of the 
rows in the linked micromap plot\index{Linked micromap plot}. Here, `Cond_med` 
from the `wv_data` argument is used. The sorting of the rows goes from smallest (on top) to
largest (at the bottom). Finally, `grouping` specifies  the number of rows
in each of the perceptual groups (here `5` rows). This implies that the 25 subbasins
will be split into five perceptual groups showing five subbasins each.

The resulting draft linked micromap plot\index{Linked micromap plot} is shown in
Figure \@ref(fig:Ch2-creatingdraftWVdot).
We abstain from interpreting this figure at this stage, but we will provide some
helpful interpretation once we have created the final refined version of this figure
in the next step.


```{r Ch2-creatingdraftWVdot, fig.cap = 'Draft linked micromap plot\\index{Linked micromap plot}, based on the `wv_data` data frame.', fig.width = 7, fig.height = 7}
mmplot(
  stat.data = wv_data,
  map.data = wv_polys_table,
  map.link = c("Random_Wat", "ID"),
  panel.types = c("dot_legend", "labels", "dot", "dot", "map"),
  panel.data = list(NA, "Random_Wat", "cond_med1", "Cond_med", NA),
  ord.by = "Cond_med", 
  grouping = 5
)
```


### Refining the Linked Micromap Plot {#Ch2-RefiningWV}


We continue with the draft linked micromap plot\index{Linked micromap plot} from the previous
step and refine it in two main steps. As mentioned in Section \@ref(Ch2-Refining),
this refinement should only be started once
functional R code has been obtained in the previous step.

A problem that did not occur in the first example in Section \@ref(Ch2-Refining) is the
length of many subregion names that considerably exceed the allocated space for this column
as can be seen in Figure \@ref(fig:Ch2-creatingdraftWVdot). Instead of using full terms,
we shorten the names of the subbasins, in particular those seven names that combine smaller
hydrologic unit codes\index{Hydrologic unit code}
(HUC) with larger neighboring HUCs (here HUC 8 at the subbasin level) in the West Virginia sampling frame.
Overall, the following abbreviations are introduced and added as part of the new `short_name` variable
to the `wv_data` data frame: 
L. (Lower), M. (Middle), U. (Upper), N. (North), S. (South),
Br. (Branch), Dunk. (Dunkard), Mononga. (Monongahela), Shen. (Shenandoah), and Youg. (Youghiogheny).
Shortening the subregion names often is recommended to avoid that the names column 
occupies too much space in the final linked micromap plot\index{Linked micromap plot}.


```{r Ch2-shortennamesWV}
wv_data$short_name <- as.factor(wv_data$Random_Wat)

levels(wv_data$short_name) <- list(
  "S. Br. Potomac" = "South Branch Potomac",
  "N. Br. Potomac" = "North Branch Potomac",
  "Cacapon/Shen." = "Cacapon/Shenandoah Hardy",
  "Potomac/Shen." = "Potomac Direct Drains/Shenandoah Jefferson",
  "U. New/James" = "Upper New/James",
  "Tygart Valley" = "Tygart Valley",
  "West Fork" = "West Fork",
  "Mononga./Dunk." = "Monongahela/Dunkard",
  "Cheat/Youg." = "Cheat/Youghiogheny",
  "U. Ohio N./S." = "Upper Ohio North/Upper Ohio South",
  "M. Ohio N." = "Middle Ohio North",
  "M. Ohio S." = "Middle Ohio South",
  "Little Kanawha" = "Little Kanawha",
  "Greenbrier" = "Greenbrier",
  "L. New" = "Lower New",
  "Gauley" = "Gauley",
  "U. Kanawha" = "Upper Kanawha",
  "Elk" = "Elk",
  "L. Kanawha" = "Lower Kanawha",
  "Coal" = "Coal",
  "U. Guyandotte" = "Upper Guyandotte",
  "L. Guyandotte" = "Lower Guyandotte",
  "Tug Fork" = "Tug Fork",
  "Big Sandy/L. Ohio" = "Big Sandy/Lower Ohio",
  "Twelvepole" = "Twelvepole"
)
```


In the first refined linked micromap plot\index{Linked micromap plot}, shown in 
Figure \@ref(fig:Ch2-refining1WV), we make use of these abbreviations 
via the newly added `short_name` variable of the `wv_data` data frame.
Moreover, we introduce initial boxplots\index{Boxplot} and 
dotplots with confidence bounds\index{Dotplot with confidence bounds} 
in the two statistical graphics columns.
This is done via `box_summary` and `dot_cl` for the `panel.types` argument.
A boxplot\index{Boxplot} requires five components 
(minimum, first quartile, median, third quartile, and maximum)
and a dotplot with confidence bounds\index{Dotplot with confidence bounds}
requires three components
(median, lower 95% confidence bound, and upper 95% confidence bound)
for each subregion. These have to be passed on as lists to
the `panel.data` argument list. Here, we make use of these
components from the conductivity variable, specifically using
`list("cond_min", "condq1", "cond_med1", "condq3", "cond_max")`
for the boxplots\index{Boxplot} and
`list("Cond_med", "Cond_LCB95", "Cond_UCB95")`
for the dotplots with confidence bounds.\index{Dotplot with confidence bounds}
It should be noted that these eight components have been precalculated
for each subregion and are variables of the `wv_data` data frame. 
The `micromap::mmplot()` function does not calculate these summary
statistics by itself from a provided data frame.


```{r Ch2-refining1WV, fig.cap = 'First refined linked micromap plot\\index{Linked micromap plot}, based on the `wv_data` data frame. Main changes are the introduction of abbreviated subregion names and initial boxplots\\index{Boxplot} and dotplots with confidence bounds\\index{Dotplot with confidence bounds} in the two statistical graphics columns.', fig.width = 7, fig.height = 7}
mmplot(
  stat.data = wv_data,
  map.data = wv_polys_table,
  map.link = c("Random_Wat", "ID"),
  panel.types = c("dot_legend", "labels", "box_summary", "dot_cl", "map"),
  panel.data = list(
    NA,
    "short_name",
    list("cond_min", "condq1", "cond_med1", "condq3", "cond_max"),
    list("Cond_med", "Cond_LCB95", "Cond_UCB95"),
    NA
  ),
  ord.by = "Cond_med",
  grouping = 5
)
```


In the second (and final) refined linked micromap plot\index{Linked micromap plot}, shown in 
Figure \@ref(fig:Ch2-refining2WV), we make similar changes as for the third through six
refined linked micromap plots\index{Linked micromap plot} in Section \@ref(Ch2-Refining).
This includes a reverse sorting (`rev.ord = TRUE`) that places the largest median conductivity on top, 
a specific color scheme (`colors = RColorBrewer::brewer.pal(n = 5, name = "YlGnBu")[5:1]`),
numerous changes to the sizes and spacing of the perceptual groups and columns,
and the addition of titles, scales, and axis labels.
We keep the maps on the right side in the fifth column. 
A square plot symbol (instead of a circular one) is used in the first column 
via `point.type = 15` in the first list of the `panel.att` list.
The thickness of the boxes in the third column (i.e., the first statistical graphics column)
is reduced via `graph.bar.size = 0.7` in the third list of the `panel.att` list.
The dashed black line in the fourth column (i.e., the second statistical graphics column)
is created via the settings `add.line = 129, add.line.col = "black", add.line.typ = "dashed"`
in the fourth list of the `panel.att` list.
The value `129` represents the estimated median conductivity 
across all 4th order streams (or less).


```{r Ch2-refining2WV, fig.cap = 'Second (and final) refined linked micromap plot\\index{Linked micromap plot}, based on the `wv_data` data frame. Main changes are related to sorting, coloring, spacing, and labeling. An overall statistics (or criteria) line has been added to the second statistical graphics column.', fig.width = 7, fig.height = 7}
mmplot(
  stat.data = wv_data,
  map.data = wv_polys_table,
  map.link = c("Random_Wat", "ID"),
  panel.types = c("dot_legend", "labels", "box_summary", "dot_cl", "map"),
  panel.data = list(
    NA,
    "short_name",
    list("cond_min", "condq1", "cond_med1", "condq3", "cond_max"),
    list("Cond_med", "Cond_LCB95", "Cond_UCB95"),
    NA
  ),
  ord.by = "Cond_med", 
  rev.ord = TRUE,
  grouping = 5, 
  plot.pGrp.spacing = 1.2,
  colors = RColorBrewer::brewer.pal(n = 5, name = "YlGnBu")[5:1],
  panel.att = list(
    list(
      1,
      panel.width = 1.6, 
      point.type = 15, 
      point.size = 1.2,
      point.border = TRUE
    ),
    list(
      2,
      header = "WVDEP\nSubbasins", 
      panel.width = 1.25,
      align = "left", 
      text.size = 0.8
    ),
    list(
      3,
      header = "Observed Conductivity\n4th Order Streams or Less",
      graph.bgcolor = "lightgray",
      graph.bar.size = 0.7,
      xaxis.ticks = c(0, 1000, 2000, 3000, 4000, 5000),
      xaxis.labels = c(0, 1, 2, 3, 4, 5),
      xaxis.labels.size = 1.25,
      xaxis.title = "Conductivity [in 1,000]", 
      xaxis.title.size = 1.25, 
      panel.width = 2,
      right.margin = 0,
      left.margin = -0.5
    ),
    list(
      4,
      header = "Estimated Conductivity\n4th Order Streams or Less",
      graph.bgcolor = "lightgray",
      xaxis.ticks = list(0, 150, 300, 450, 600, 750),
      xaxis.labels = list(0, 150, 300, 450, 600, 750),
      xaxis.labels.size = 1.25,
      xaxis.title = "Conductivity",
      add.line = 129, 
      add.line.col = "black", 
      add.line.typ = "dashed",
      xaxis.title.size = 1.25, 
      panel.width = 2,
      right.margin = 0.1,
      left.margin = -0.5
    ),
    list(
      5,
      header = "Light Gray Means\nHighlighted Above",
      inactive.border.color = gray(0.7), 
      inactive.border.size = 1.5,
      panel.width = 1.5
    )
  )
)
```


What remains to be done is a summary and interpretation of the 
final refined linked micromap plot\index{Linked micromap plot} shown in Figure \@ref(fig:Ch2-refining2WV).
This plot is related to conductivity in 25 aggregated watersheds and 
subbasins of 4th order streams (or less) in West Virginia in the United States. 
The first stastical graphics column shows boxplots\index{Boxplot} for the 
observed conductivities for each of these watersheds. The second statistical graphics column 
shows dotplots with confidence bounds\index{Dotplot with confidence bounds} 
that are the population estimates representing the median, the lower 95% confidence bound, 
and the upper 95% confidence bound for each of these watersheds.

The rows in the plot are sorted from highest (on top) to lowest (at the bottom) estimated conductivity
that is shown in the second statistical graphics column.
Each consecutive map shows which subregions have been colored previously in the map(s) above. 
There is a weak spatial pattern with the highest estimated conductivities in the northern and 
western subbasins of West Virginia. There is a notable spatial cluster in the 
central-eastern subbasins of West Virginia with the five lowest estimated conductivities
shown in the perceptual group at the bottom of the plot.

The second statistical graphics column reveals that there is a remarkable relationship between 
the widths of the confidence bounds and the estimated conductivities. The higher the 
estimated conductivity, the wider the confidence bound in general.  The value 129, 
representing the estimated median conductivity across all 4th order streams (or less), 
has been overlaid on this column.

Such a pattern cannot be noticed in the boxplots in the first statistical graphics column. 
Here, some extreme outliers dominate, e.g., observed conductivities of about 5,000 
in the Little Kanawha subbasin and of about 4,000 in the Lower (L.) Kanawha subbasin.

While this is hard to visually detect due to these extreme outliers, there is a 
considerable positive correlation between the observed median conductivity and 
the estimated median conductivity. Not surprisingly, the correlation coefficient $r$ is 
about `r round(cor(wv_data$cond_med1, wv_data$Cond_med), digits = 2)`.


## Summary and Further Reading {#Ch2-SummaryFurtherReading}


In this chapter, we have discussed the four main steps that are required 
to create linked micromap plots\index{Linked micromap plot} with 
the **micromap**\index{R Packages!micromap} R Package [@PaOl2015].
This R package is one of two major R packages for the construction of 
linked micromap plots.\index{Linked micromap plot}
We will encounter it in several of the following chapters again.
When designing linked micromap plots\index{Linked micromap plot} in those chapters,
the authors typically have followed the same main steps. However,
in most cases, only the final refined linked micromap plot\index{Linked micromap plot}
will be shown in the following chapters.

In Chapter \@ref(Ch4), we will see how to modify external shapefiles\index{Shapefiles}
that contain too many edges and/or contain subregions that are too large, too small,
or located too far away from the main geographic area --- and then construct
linked micromap plots\index{Linked micromap plot} that are based on the modified 
shapefiles.\index{Shapefiles}
In Chapter \@ref(Ch5), we will discuss how to display different types
of statistical graphics in the statistical graphics columns
in addition to dotplots,\index{Dotplot}
boxplots\index{Boxplot}, and
dotplots with confidence bounds\index{Dotplot with confidence bounds}
that were introduced in this chapter.

Chapter \@ref(Ch6) discusses linked micromap plots\index{Linked micromap plot}
that are based on point locations, rather than on areal data as in this chapter.
In Chapter \@ref(Ch7), we will see how to construct linked micromap plots\index{Linked micromap plot}
in a web-based environment. Finally, in Chapter \@ref(Ch11), we will
find applications of linked micromap plots\index{Linked micromap plot}
in the environmental field. We will see the example with the
watersheds in West Virginia, first introduced in Section \@ref(Ch2-Example2),
again in that chapter. These three chapters primarily make 
use of the **micromap**\index{R Packages!micromap} R package
although the **micromapST**\index{R Packages!micromapST} R package
could be used in a similar way.

We want to finish this chapter with some practical recommendations.
When working with Rmarkdown or bookdown, REFERENCES
sizing the figures with the linked micromap plots\index{Linked micromap plot} for the United States
as `fig.width = 7, fig.height = 9` works well.
For linked micromap plots\index{Linked micromap plot} used in journal publications,
using the arguments `plot.width = 7, plot.height = 9` often works well.
For linked micromap plots\index{Linked micromap plot} used in poster and presentation slides,
using the arguments `plot.width = 9, plot.height = 6` usually works better.
Ultimately, the width is somewhat determined by the number of statistical graphics columns.
A linked micromap plot\index{Linked micromap plot} with only one statistical graphics column
has to be less wide than one with three or four statistical graphics columns.
Similarly, the height is somewhat determined by the number of perceptual groups.
A linked micromap plot\index{Linked micromap plot} with only two or three perceptual groups
has to be less tall than one with nine or ten perceptual groups.

Some additional examples of linked micromap plots\index{Linked micromap plot}
created with the **micromap**\index{R Packages!micromap} R package are related
to pesticides in 
Florida Department of Environmental Protection (FDEP) drainage basins [@SWSCSS2018],
to variables from the Virginia Stream Condition Index (VSCI) and the 
Virginia Coastal Plain Macroinvertebrate Index (VCPMI) [@VirginiaDEQ2020],
and to housing and immigration variables from the subboroughs in New York City [@Medri2021] --- all 
within the United States.
International examples are related
to population data in selected countries from South America [@SDWPM2014],
to suicide data by prefecture in Japan [@KIT2015],
and to the spatial distributions of religions in China [@SBDSS2016].
Some of these required additional modifications of
external shapefiles\index{Shapefiles}
as discussed in Chapter \@ref(Ch4).


\printbibliography[segment=\therefsegment,heading=subbibliography]
